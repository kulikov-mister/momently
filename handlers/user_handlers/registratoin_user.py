from aiogram import Router, F
from aiogram.types import Message, KeyboardButton
from aiogram.fsm.context import FSMContext
from Filter.Filter import IsNotCommand
from aiogram.utils.keyboard import ReplyKeyboardBuilder
from database.add_to_db import add_user
from handlers.user_handlers import main_menu_user
from keyboards.reply import reply_menu_user
from loader import dp
from states.user_states import UserRegistrationState

router = Router()
dp.include_router(router)


@router.message(IsNotCommand(), UserRegistrationState.name)
async def process_name_step(message: Message, state: FSMContext):
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    await state.update_data(name=message.text)

    await state.set_state(UserRegistrationState.phone)

    builder = ReplyKeyboardBuilder()
    builder.row(
        KeyboardButton(text='ğŸ“© ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ', request_contact=True)
    )
    kb = builder.as_markup(resize_keyboard=True, one_time_keyboard=True)

    await message.answer('ğŸ“² ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ ÑĞ²Ğ¾Ğ¸Ğ¼ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ¼\n\n'
                         'Ğ”Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ <b>ğŸ“© ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ğŸ“©</b>\n'
                         'ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½ğŸ”½', reply_markup=kb)


@router.message(F.contact, UserRegistrationState.phone)
async def process_phone_step(message: Message, state: FSMContext):
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    data = await state.get_data()
    user_name = data.get('name')

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°
    user_phone = message.contact.phone_number
    user_id = message.from_user.id

    add_user(user_id, user_name, user_phone)

    await message.answer('âœ… Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°!', reply_markup=reply_menu_user.get_main_menu_keyboard())
    await main_menu_user.main_menu(message)
